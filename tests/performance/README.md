# æ€§èƒ½æµ‹è¯•æ–‡æ¡£

æœ¬ç›®å½•åŒ…å«å•†åŸç³»ç»Ÿçš„å®Œæ•´æ€§èƒ½æµ‹è¯•å¥—ä»¶ï¼Œæä¾›å¤šç§æ€§èƒ½æµ‹è¯•å·¥å…·å’Œæ–¹æ³•ã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

```
tests/performance/
â”œâ”€â”€ README.md                    # æœ¬æ–‡ä»¶ - æ€§èƒ½æµ‹è¯•è¯´æ˜
â”œâ”€â”€ locustfile.py               # Locustè´Ÿè½½æµ‹è¯•é…ç½®
â”œâ”€â”€ test_performance.py         # pytestæ€§èƒ½æµ‹è¯•ç”¨ä¾‹
â”œâ”€â”€ run_performance_tests.py    # æ€§èƒ½æµ‹è¯•è¿è¡Œè„šæœ¬
â””â”€â”€ reports/                    # æµ‹è¯•æŠ¥å‘Šç›®å½•ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
    â”œâ”€â”€ locust_*.html           # Locust HTMLæŠ¥å‘Š
    â”œâ”€â”€ locust_*_stats.csv      # Locustç»Ÿè®¡æ•°æ®
    â”œâ”€â”€ pytest_*.html          # pytest HTMLæŠ¥å‘Š
    â””â”€â”€ performance_summary_*.json  # æ±‡æ€»æŠ¥å‘Š
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
# è‡ªåŠ¨å®‰è£…æ‰€æœ‰ä¾èµ–
python tests/performance/run_performance_tests.py --install-deps

# æˆ–æ‰‹åŠ¨å®‰è£…
pip install pytest pytest-benchmark pytest-xdist pytest-html pytest-json-report locust requests
```

### 2. å¯åŠ¨åº”ç”¨ç¨‹åº

ç¡®ä¿å•†åŸåº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œï¼š

```bash
cd app
python app.py
```

åº”ç”¨ç¨‹åºåº”è¯¥åœ¨ `http://localhost:5000` ä¸Šè¿è¡Œã€‚

### 3. è¿è¡Œæ€§èƒ½æµ‹è¯•

```bash
# å¿«é€Ÿæ€§èƒ½æµ‹è¯•ï¼ˆæ¨èé¦–æ¬¡ä½¿ç”¨ï¼‰
python tests/performance/run_performance_tests.py --quick

# å®Œæ•´æ€§èƒ½æµ‹è¯•
python tests/performance/run_performance_tests.py --full

# å‹åŠ›æµ‹è¯•
python tests/performance/run_performance_tests.py --stress

# ä»…è¿è¡ŒLocustè´Ÿè½½æµ‹è¯•
python tests/performance/run_performance_tests.py --locust --users 20 --duration 120s
```

## ğŸ“Š æµ‹è¯•ç±»å‹è¯´æ˜

### 1. åŸºç¡€æ€§èƒ½æµ‹è¯• (pytest)

**æ–‡ä»¶**: `test_performance.py`

**æµ‹è¯•å†…å®¹**:
- é¡µé¢å“åº”æ—¶é—´æµ‹è¯•
- å¹¶å‘è®¿é—®æµ‹è¯•
- å‹åŠ›æµ‹è¯•
- å†…å­˜æ³„æ¼æ£€æµ‹

**è¿è¡Œæ–¹å¼**:
```bash
# è¿è¡Œæ‰€æœ‰pytestæ€§èƒ½æµ‹è¯•
pytest tests/performance/test_performance.py -v

# ä»…è¿è¡ŒåŸºå‡†æµ‹è¯•
pytest tests/performance/test_performance.py -v --benchmark-only

# å¹¶å‘æµ‹è¯•
pytest tests/performance/test_performance.py -v -n 4

# è¿è¡Œç‰¹å®šæµ‹è¯•
pytest tests/performance/test_performance.py -v -k "homepage"
```

**æ€§èƒ½åŸºå‡†**:
- é¦–é¡µå“åº”æ—¶é—´: < 1.0s (ç›®æ ‡: 0.5s)
- å•†å“é¡µé¢å“åº”æ—¶é—´: < 2.0s (ç›®æ ‡: 1.0s)
- å•†å“è¯¦æƒ…å“åº”æ—¶é—´: < 1.5s (ç›®æ ‡: 0.8s)
- ç™»å½•é¡µé¢å“åº”æ—¶é—´: < 2.0s (ç›®æ ‡: 1.0s)
- æœç´¢åŠŸèƒ½å“åº”æ—¶é—´: < 3.0s (ç›®æ ‡: 1.5s)

### 2. è´Ÿè½½æµ‹è¯• (Locust)

**æ–‡ä»¶**: `locustfile.py`

**æµ‹è¯•å†…å®¹**:
- æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸º
- å¤šç§ç”¨æˆ·ç±»å‹ï¼ˆæ™®é€šç”¨æˆ·ã€ç®¡ç†å‘˜ã€å‹åŠ›æµ‹è¯•ç”¨æˆ·ï¼‰
- ä¸åŒé¢‘ç‡çš„æ“ä½œä»»åŠ¡

**ç”¨æˆ·è¡Œä¸ºæ¨¡æ‹Ÿ**:
- **æ™®é€šç”¨æˆ·** (ShopUser): æµè§ˆå•†å“ã€æœç´¢ã€è´­ç‰©è½¦æ“ä½œ
- **ç®¡ç†å‘˜ç”¨æˆ·** (AdminUser): ç®¡ç†åå°æ“ä½œ
- **å¿«é€Ÿæµ‹è¯•ç”¨æˆ·** (QuickTestUser): åŸºç¡€åŠŸèƒ½éªŒè¯
- **å‹åŠ›æµ‹è¯•ç”¨æˆ·** (StressTestUser): é«˜é¢‘è®¿é—®æµ‹è¯•

**è¿è¡Œæ–¹å¼**:
```bash
# å‘½ä»¤è¡Œæ¨¡å¼ï¼ˆæ¨èï¼‰
locust -f tests/performance/locustfile.py --host=http://localhost:5000 --users 10 --spawn-rate 2 --run-time 60s --headless

# Webç•Œé¢æ¨¡å¼
locust -f tests/performance/locustfile.py --host=http://localhost:5000 --web-host=0.0.0.0 --web-port=8089
# ç„¶åè®¿é—® http://localhost:8089

# ä½¿ç”¨è¿è¡Œè„šæœ¬
python tests/performance/run_performance_tests.py --locust --users 20 --duration 120s
```

## ğŸ”§ æµ‹è¯•é…ç½®

### æ€§èƒ½åŸºå‡†é…ç½®

åœ¨ `test_performance.py` ä¸­çš„ `PerformanceTestConfig` ç±»ï¼š

```python
class PerformanceTestConfig:
    BASE_URL = 'http://localhost:5000'
    TIMEOUT = 10  # è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    MAX_RESPONSE_TIME = 2.0  # æœ€å¤§å¯æ¥å—å“åº”æ—¶é—´ï¼ˆç§’ï¼‰
    CONCURRENT_USERS = 10  # å¹¶å‘ç”¨æˆ·æ•°
    REQUESTS_PER_USER = 5  # æ¯ä¸ªç”¨æˆ·çš„è¯·æ±‚æ•°
    
    # æ€§èƒ½åŸºå‡†
    BENCHMARKS = {
        'homepage': {'max_time': 1.0, 'target_time': 0.5},
        'products': {'max_time': 2.0, 'target_time': 1.0},
        # ... æ›´å¤šé…ç½®
    }
```

### Locusté…ç½®

åœ¨ `locustfile.py` ä¸­å¯ä»¥è°ƒæ•´ï¼š

```python
class ShopUser(HttpUser):
    wait_time = between(1, 3)  # ç”¨æˆ·è¯·æ±‚é—´éš”æ—¶é—´
    
    @task(10)  # ä»»åŠ¡æƒé‡
    def view_homepage(self):
        # ä»»åŠ¡å®ç°
```

## ğŸ“ˆ æµ‹è¯•æŠ¥å‘Š

### pytestæŠ¥å‘Š

- **HTMLæŠ¥å‘Š**: åŒ…å«è¯¦ç»†çš„æµ‹è¯•ç»“æœå’Œå›¾è¡¨
- **JSONæŠ¥å‘Š**: æœºå™¨å¯è¯»çš„æµ‹è¯•æ•°æ®
- **åŸºå‡†æŠ¥å‘Š**: æ€§èƒ½åŸºå‡†æµ‹è¯•ç»“æœ

### LocustæŠ¥å‘Š

- **HTMLæŠ¥å‘Š**: åŒ…å«è¯·æ±‚ç»Ÿè®¡ã€å“åº”æ—¶é—´åˆ†å¸ƒã€å¤±è´¥ç‡ç­‰
- **CSVæ•°æ®**: è¯¦ç»†çš„ç»Ÿè®¡æ•°æ®ï¼Œå¯ç”¨äºè¿›ä¸€æ­¥åˆ†æ

### æ±‡æ€»æŠ¥å‘Š

è¿è¡Œè„šæœ¬ä¼šç”ŸæˆJSONæ ¼å¼çš„æ±‡æ€»æŠ¥å‘Šï¼ŒåŒ…å«ï¼š
- æ‰€æœ‰æµ‹è¯•çš„æ‰§è¡Œç»“æœ
- æ€»ä½“ç»Ÿè®¡ä¿¡æ¯
- æŠ¥å‘Šæ–‡ä»¶è·¯å¾„

## ğŸ¯ æµ‹è¯•åœºæ™¯

### åœºæ™¯1: æ—¥å¸¸æ€§èƒ½ç›‘æ§

```bash
# æ¯æ—¥å¿«é€Ÿæ£€æŸ¥
python tests/performance/run_performance_tests.py --quick
```

**ç›®çš„**: å¿«é€ŸéªŒè¯ç³»ç»ŸåŸºæœ¬æ€§èƒ½
**é¢‘ç‡**: æ¯æ—¥æˆ–æ¯æ¬¡éƒ¨ç½²å
**æ—¶é—´**: çº¦2-3åˆ†é’Ÿ

### åœºæ™¯2: ç‰ˆæœ¬å‘å¸ƒå‰æµ‹è¯•

```bash
# å®Œæ•´æ€§èƒ½æµ‹è¯•
python tests/performance/run_performance_tests.py --full
```

**ç›®çš„**: å…¨é¢è¯„ä¼°ç³»ç»Ÿæ€§èƒ½
**é¢‘ç‡**: ç‰ˆæœ¬å‘å¸ƒå‰
**æ—¶é—´**: çº¦10-15åˆ†é’Ÿ

### åœºæ™¯3: å®¹é‡è§„åˆ’æµ‹è¯•

```bash
# å‹åŠ›æµ‹è¯•
python tests/performance/run_performance_tests.py --stress
```

**ç›®çš„**: ç¡®å®šç³»ç»Ÿå®¹é‡ä¸Šé™
**é¢‘ç‡**: æœˆåº¦æˆ–å­£åº¦
**æ—¶é—´**: çº¦15-20åˆ†é’Ÿ

### åœºæ™¯4: è´Ÿè½½æµ‹è¯•

```bash
# æ¨¡æ‹ŸçœŸå®è´Ÿè½½
python tests/performance/run_performance_tests.py --locust --users 50 --duration 300s
```

**ç›®çš„**: æ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒè´Ÿè½½
**é¢‘ç‡**: é‡å¤§æ›´æ–°å‰
**æ—¶é—´**: 5-10åˆ†é’Ÿ

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡è¯´æ˜

### å“åº”æ—¶é—´æŒ‡æ ‡

- **å¹³å‡å“åº”æ—¶é—´**: æ‰€æœ‰è¯·æ±‚çš„å¹³å‡å“åº”æ—¶é—´
- **ä¸­ä½æ•°å“åº”æ—¶é—´**: 50%çš„è¯·æ±‚å“åº”æ—¶é—´
- **P95å“åº”æ—¶é—´**: 95%çš„è¯·æ±‚å“åº”æ—¶é—´
- **P99å“åº”æ—¶é—´**: 99%çš„è¯·æ±‚å“åº”æ—¶é—´
- **æœ€å¤§å“åº”æ—¶é—´**: æœ€æ…¢çš„è¯·æ±‚å“åº”æ—¶é—´

### ååé‡æŒ‡æ ‡

- **RPS (Requests Per Second)**: æ¯ç§’è¯·æ±‚æ•°
- **å¹¶å‘ç”¨æˆ·æ•°**: åŒæ—¶è®¿é—®çš„ç”¨æˆ·æ•°
- **æˆåŠŸç‡**: æˆåŠŸè¯·æ±‚çš„ç™¾åˆ†æ¯”

### èµ„æºä½¿ç”¨æŒ‡æ ‡

- **å†…å­˜ä½¿ç”¨**: åº”ç”¨ç¨‹åºå†…å­˜æ¶ˆè€—
- **CPUä½¿ç”¨**: å¤„ç†å™¨ä½¿ç”¨ç‡
- **ç½‘ç»œå¸¦å®½**: ç½‘ç»œä¼ è¾“é‡

## ğŸš¨ æ€§èƒ½é—®é¢˜è¯Šæ–­

### å¸¸è§æ€§èƒ½é—®é¢˜

1. **å“åº”æ—¶é—´è¿‡é•¿**
   - æ£€æŸ¥æ•°æ®åº“æŸ¥è¯¢æ•ˆç‡
   - ä¼˜åŒ–é™æ€èµ„æºåŠ è½½
   - è€ƒè™‘æ·»åŠ ç¼“å­˜

2. **å¹¶å‘æ€§èƒ½å·®**
   - æ£€æŸ¥æ•°æ®åº“è¿æ¥æ± é…ç½®
   - ä¼˜åŒ–é”æœºåˆ¶
   - è€ƒè™‘å¼‚æ­¥å¤„ç†

3. **å†…å­˜æ³„æ¼**
   - è¿è¡Œå†…å­˜æ³„æ¼æ£€æµ‹æµ‹è¯•
   - æ£€æŸ¥å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†
   - ç›‘æ§é•¿æ—¶é—´è¿è¡Œçš„è¿›ç¨‹

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å‰ç«¯ä¼˜åŒ–**
   - å‹ç¼©CSS/JSæ–‡ä»¶
   - ä¼˜åŒ–å›¾ç‰‡å¤§å°
   - ä½¿ç”¨CDN

2. **åç«¯ä¼˜åŒ–**
   - æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
   - æŸ¥è¯¢è¯­å¥ä¼˜åŒ–
   - ç¼“å­˜ç­–ç•¥

3. **æ¶æ„ä¼˜åŒ–**
   - è´Ÿè½½å‡è¡¡
   - å¾®æœåŠ¡æ¶æ„
   - å¼‚æ­¥å¤„ç†

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **åº”ç”¨ç¨‹åºæœªè¿è¡Œ**
   ```
   âŒ æ— æ³•è¿æ¥åˆ°åº”ç”¨ç¨‹åº: http://localhost:5000
   ```
   **è§£å†³æ–¹æ¡ˆ**: å¯åŠ¨åº”ç”¨ç¨‹åº `python app/app.py`

2. **ä¾èµ–åŒ…ç¼ºå¤±**
   ```
   ModuleNotFoundError: No module named 'locust'
   ```
   **è§£å†³æ–¹æ¡ˆ**: å®‰è£…ä¾èµ– `pip install locust`

3. **ç«¯å£å†²çª**
   ```
   Address already in use
   ```
   **è§£å†³æ–¹æ¡ˆ**: æ›´æ”¹ç«¯å£æˆ–åœæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹

4. **æµ‹è¯•è¶…æ—¶**
   ```
   requests.exceptions.Timeout
   ```
   **è§£å†³æ–¹æ¡ˆ**: å¢åŠ è¶…æ—¶æ—¶é—´æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è¯¦ç»†æ—¥å¿—**
   ```bash
   pytest tests/performance/test_performance.py -v -s
   ```

2. **å•ç‹¬è¿è¡Œæµ‹è¯•**
   ```bash
   pytest tests/performance/test_performance.py::TestBasicPerformance::test_homepage_response_time -v
   ```

3. **æ£€æŸ¥åº”ç”¨ç¨‹åºæ—¥å¿—**
   ```bash
   # æŸ¥çœ‹åº”ç”¨ç¨‹åºè¾“å‡º
   tail -f app.log
   ```

## ğŸ“‹ æœ€ä½³å®è·µ

### æµ‹è¯•æ‰§è¡Œ

1. **æµ‹è¯•å‰å‡†å¤‡**
   - ç¡®ä¿æµ‹è¯•ç¯å¢ƒç¨³å®š
   - æ¸…ç†æµ‹è¯•æ•°æ®
   - é‡å¯åº”ç”¨ç¨‹åº

2. **æµ‹è¯•æ‰§è¡Œ**
   - ä»å¿«é€Ÿæµ‹è¯•å¼€å§‹
   - é€æ­¥å¢åŠ è´Ÿè½½
   - ç›‘æ§ç³»ç»Ÿèµ„æº

3. **ç»“æœåˆ†æ**
   - å¯¹æ¯”å†å²æ•°æ®
   - è¯†åˆ«æ€§èƒ½è¶‹åŠ¿
   - è®°å½•ä¼˜åŒ–æªæ–½

### æŒç»­é›†æˆ

1. **è‡ªåŠ¨åŒ–æ‰§è¡Œ**
   ```yaml
   # CI/CDé…ç½®ç¤ºä¾‹
   performance_test:
     script:
       - python tests/performance/run_performance_tests.py --quick
   ```

2. **æ€§èƒ½å›å½’æ£€æµ‹**
   - è®¾ç½®æ€§èƒ½åŸºå‡†
   - è‡ªåŠ¨å¯¹æ¯”ç»“æœ
   - æ€§èƒ½ä¸‹é™æ—¶å‘Šè­¦

3. **æŠ¥å‘Šå½’æ¡£**
   - ä¿å­˜å†å²æŠ¥å‘Š
   - ç”Ÿæˆè¶‹åŠ¿å›¾è¡¨
   - å®šæœŸæ¸…ç†æ—§æŠ¥å‘Š

## ğŸ“ æ”¯æŒå’Œè”ç³»

### æŠ€æœ¯æ”¯æŒ

- **æ€§èƒ½é—®é¢˜**: è”ç³»å¼€å‘å›¢é˜Ÿ
- **æµ‹è¯•å·¥å…·**: è”ç³»æµ‹è¯•å›¢é˜Ÿ
- **ç¯å¢ƒé—®é¢˜**: è”ç³»è¿ç»´å›¢é˜Ÿ

### ç›¸å…³èµ„æº

- [Locustå®˜æ–¹æ–‡æ¡£](https://docs.locust.io/)
- [pytest-benchmarkæ–‡æ¡£](https://pytest-benchmark.readthedocs.io/)
- [æ€§èƒ½æµ‹è¯•æœ€ä½³å®è·µ](https://martinfowler.com/articles/practical-test-pyramid.html)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2024å¹´  
**æœ€åæ›´æ–°**: 2024å¹´  
**ç»´æŠ¤å›¢é˜Ÿ**: æµ‹è¯•å›¢é˜Ÿ  

> ğŸ’¡ **æç¤º**: å»ºè®®å…ˆè¿è¡Œå¿«é€Ÿæµ‹è¯•ç†Ÿæ‚‰å·¥å…·ï¼Œç„¶åæ ¹æ®éœ€è¦é€‰æ‹©åˆé€‚çš„æµ‹è¯•ç±»å‹ã€‚

> âš ï¸ **æ³¨æ„**: å‹åŠ›æµ‹è¯•å¯èƒ½ä¼šå¯¹ç³»ç»Ÿé€ æˆè¾ƒå¤§è´Ÿè½½ï¼Œè¯·åœ¨åˆé€‚çš„ç¯å¢ƒä¸­æ‰§è¡Œã€‚